```NOTE: this document is generated by AI```

# Login Flow Documentation

This document describes the three authentication routes in OpenConext-myconext and how they converge to redirect the user back to the Service Provider.

## Overview

All authentication flows are handled by `GuestIdpAuthenticationRequestFilter.java`, which processes incoming SAML authentication requests and manages the various login methods. Regardless of the route taken, all paths converge to a single point: `sendAssertion()`, which sends the SAML response back to the Service Provider.

---

## Login Routes

### 1. SSO / Cookie-Based Login

**When it applies:** The user has an existing session via a remember-me cookie or is already authenticated.

**Flow:**
1. User arrives with a valid `GUEST_IDP_REMEMBER_ME_COOKIE` or an active security context
2. The filter retrieves the user via `userFromCookie()` or `userFromAuthentication()`
3. If no step-up authentication is required, proceeds directly to `sendAssertion()`

**Key methods:**
- `userFromCookie()` (line 368) — Retrieves user from remember-me cookie
- `userFromAuthentication()` (line 374) — Retrieves user from Spring Security context
- `sendAssertion()` (line 685) — Sends the SAML assertion

**Entry point:** `doFilterInternal()` → SSO path at line 260

---

### 2. Magic Link / Email Code Login

**When it applies:** User authenticates via a one-time login code sent by email.

**Flow:**
1. User requests login, receives email with magic link containing a hash parameter
2. User clicks the link, hitting the `/saml/guest-idp/magic` endpoint
3. The `magic()` method validates the hash and retrieves the authentication request
4. **Same device:** Proceeds to `doSendAssertion()`
5. **Different device:** Sends a verification code email, user must enter it on the original device via `continueAfterLogin()`

**Key methods:**
- `magic()` (line 405) — Handles magic link clicks
- `continueAfterLogin()` (line 552) — Handles verification code submission from different device
- `doSendAssertion()` (line 589) — Prepares session and cookies, then calls `sendAssertion()`

**Email sending:**
- One-time login codes: `UserController.java` → `mailBox.sendOneTimeLoginCode()` (line 1434)
- Verification codes: `GuestIdpAuthenticationRequestFilter.java` → `mailBox.sendVerificationCode()` (line 454)

---

### 3. Tiqr / App-Based Login

**When it applies:** User authenticates via the eduID mobile app using Tiqr protocol.

**Flow:**
1. User initiates login, selects app-based authentication
2. Tiqr authentication is handled externally, setting `samlAuthenticationRequest.setTiqrFlow(true)`
3. Upon successful app authentication, the flow returns to `doSendAssertion()`
4. A Tiqr cookie is set for future MFA SSO

**Key methods:**
- `doSendAssertion()` (line 589) — Detects Tiqr flow and adds Tiqr cookie via `addTiqrCookie()`
- `addTiqrCookie()` (line 637) — Sets the `TIQR_COOKIE` for app-based sessions

**External handling:**
- `TiqrController.java` — Manages Tiqr enrollment and authentication
- Calls `computeEduIdForServiceProviderIfAbsent()` at line 489

---

## Convergence Point

All three routes converge at `sendAssertion()` (line 685), which:

1. Builds SAML attributes via `attributes()` (line 774)
2. Determines the appropriate Authentication Context Class Reference (ACR)
3. Logs the login method (cookie, one_time_login_code, password, or tiqr)
4. Calls `samlService.sendResponse()` to redirect the user to the SP

```
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│   SSO/Cookie    │   │   Magic Link    │   │   Tiqr/App      │
└────────┬────────┘   └────────┬────────┘   └────────┬────────┘
         │                     │                     │
         │              ┌──────▼──────┐              │
         │              │   magic()   │              │
         │              └──────┬──────┘              │
         │                     │                     │
         │           ┌─────────┴─────────┐           │
         │           │                   │           │
         │    Same Device         Different Device   │
         │           │                   │           │
         │           │         ┌─────────▼─────────┐ │
         │           │         │continueAfterLogin │ │
         │           │         └─────────┬─────────┘ │
         │           │                   │           │
         │           └─────────┬─────────┘           │
         │                     │                     │
         │              ┌──────▼──────┐              │
         │              │doSendAssertion│◄───────────┘
         │              └──────┬──────┘
         │                     │
         └──────────────┬──────┘
                        │
                ┌───────▼───────┐
                │ sendAssertion │
                └───────┬───────┘
                        │
              ┌─────────▼─────────┐
              │samlService.       │
              │sendResponse()     │  ◄── Redirect to SP
              └───────────────────┘
```

---

## Key Files

| File | Purpose |
|------|---------|
| `GuestIdpAuthenticationRequestFilter.java` | Main authentication filter, handles all login routes |
| `UserController.java` | REST endpoints for user operations, sends one-time login codes |
| `TiqrController.java` | Handles Tiqr app authentication |
| `MailBox.java` | Email service for sending login codes and verification codes |
| `User.java` | User model, computes eduID and manages lastLogin |
| `SamlAuthenticationRequest.java` | Stores authentication request state |

---

## LastLogin Tracking

Two `lastLogin` fields are maintained:

- **`User.lastLogin`** — Overall last login timestamp for the user
- **`ServiceProvider.lastLogin`** — Last login per service provider

These are updated in `User.doComputeEduIDIfAbsent()` (line 219), which is called from `attributes()` just before the SAML assertion is sent.
